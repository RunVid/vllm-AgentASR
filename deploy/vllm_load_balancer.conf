upstream vllm_backend {
    # Round-robin load balancing
    server 127.0.0.1:50002;    server 127.0.0.1:50003;    server 127.0.0.1:50004;    server 127.0.0.1:50005;    server 127.0.0.1:50006;    server 127.0.0.1:50007;    server 127.0.0.1:50008;    server 127.0.0.1:50009;
}

server {
    # Listen on port 443 for HTTPS traffic
    listen 443 ssl;
    
    # IMPORTANT: Replace 'your_server_ip_or_domain' with your server's public IP address or domain name.
    server_name 8.34.125.71;

    # SSL Certificate configuration
    # For production, use a certificate from a trusted authority like Let's Encrypt.
    ssl_certificate /etc/nginx/ssl/self-signed.crt;
    ssl_certificate_key /etc/nginx/ssl/self-signed.key;

    location / {
        # --- API Key Authentication ---
        # All clients must provide a secret key in the 'X-API-Key' header.
        if ($http_x_api_key != "6a033ce8d2c5346516741b9c38965e633b9a348d0999a31d957141e11d572f57") {
            return 401 'Unauthorized';
        }

        proxy_pass http://vllm_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
